<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/auth.service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/auth.service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { User } from "../schemas/user.schema.js";
import bcrypt from "bcrypt";
import jwt from "jsonwebtoken";

/**
 * Đăng ký người dùng mới
 * @param {object} userData - Dữ liệu người dùng
 * @returns {Promise&lt;object>} Thông tin người dùng đã đăng ký
 */
const registerUser = async (userData) => {
  const { name, email, phoneNumber, password, address } = userData;
  const existedUser = await User.findOne({ $or: [{ email }, { phoneNumber }] });

  if (existedUser?.isRegistered) {
    throw { status: 400, message: "User already exists" };
  }

  const hashedPassword = await bcrypt.hash(password, 10);
  const newUser = new User({
    name,
    email,
    phoneNumber,
    password: hashedPassword,
    address,
    isRegistered: true,
    role: "customer",
  });

  await newUser.save();
  const userResponse = newUser.toObject();
  delete userResponse.password;
  delete userResponse.refreshToken;

  return userResponse;
};

/**
 * Đăng nhập người dùng
 * @param {object} credentials - Thông tin đăng nhập
 * @returns {Promise&lt;object>} Access token và thông tin người dùng
 */
const signIn = async (credentials) => {
  const { email, phoneNumber, password } = credentials;
  const user = await User.findOne({ $or: [{ email }, { phoneNumber }], isRegistered: true });

  if (!user) {
    throw { status: 404, message: "User not found" };
  }

  const isValidPassword = await bcrypt.compare(password, user.password);
  if (!isValidPassword) {
    throw { status: 401, message: "Invalid password" };
  }

  const accessToken = jwt.sign({ id: user._id, role: user.role }, process.env.ACCESS_TOKEN_SECRET, { expiresIn: "1h" });
  return { accessToken, user };
};

/**
 * Làm mới access token
 * @param {string} refreshToken - Refresh token
 * @returns {Promise&lt;string>} Access token mới
 */
const handleRefreshToken = async (refreshToken) => {
  if (!refreshToken) {
    throw { status: 401, message: "Refresh token is required" };
  }

  const user = jwt.verify(refreshToken, process.env.REFRESH_TOKEN_SECRET);
  const accessToken = jwt.sign({ id: user.id, role: user.role }, process.env.ACCESS_TOKEN_SECRET, { expiresIn: "1h" });

  return accessToken;
};

/**
 * Đăng xuất người dùng
 * @param {string} userId - ID người dùng
 * @returns {Promise&lt;void>}
 */
const handleLogout = async (userId) => {
  const user = await User.findById(userId);
  if (!user) {
    throw { status: 404, message: "User not found" };
  }

  await User.findByIdAndUpdate(userId, { refreshToken: null });
};

/**
 * Đăng nhập quản trị viên
 * @param {object} credentials - Thông tin đăng nhập
 * @param {object} headers - HTTP headers
 * @returns {Promise&lt;object>} Access token, refresh token và thông tin quản trị viên
 */
const adminSignIn = async (credentials, headers) => {
  const { email, password, adminKey } = credentials;

  if (adminKey !== process.env.ADMIN_SECRET_KEY) {
    throw { status: 401, message: "Invalid credentials" };
  }

  const clientIP = headers["x-forwarded-for"] || headers["socket.remoteAddress"];
  const allowedAdminIPs = process.env.ADMIN_ALLOWED_IPS?.split(",") || [];

  if (allowedAdminIPs.length > 0 &amp;&amp; !allowedAdminIPs.includes(clientIP)) {
    throw { status: 403, message: "Access denied from this location" };
  }

  const admin = await User.findOne({ email, role: "admin" });
  if (!admin) {
    throw { status: 401, message: "Invalid credentials" };
  }

  const isValidPassword = await bcrypt.compare(password, admin.password);
  if (!isValidPassword) {
    throw { status: 401, message: "Invalid credentials" };
  }

  const adminAccessToken = jwt.sign({ id: admin._id, role: admin.role, isAdmin: true }, process.env.ADMIN_ACCESS_TOKEN_SECRET, { expiresIn: "30m" });
  const adminRefreshToken = jwt.sign({ id: admin._id, role: admin.role, isAdmin: true }, process.env.ADMIN_REFRESH_TOKEN_SECRET, { expiresIn: "4h" });

  admin.refreshToken = adminRefreshToken;
  admin.lastLogin = new Date();
  await admin.save();

  return { accessToken: adminAccessToken, refreshToken: adminRefreshToken, user: admin };
};

export default {
  registerUser,
  signIn,
  handleRefreshToken,
  handleLogout,
  adminSignIn,
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#CategoriesValidationSchema">CategoriesValidationSchema</a></li><li><a href="global.html#CategoryModel">CategoryModel</a></li><li><a href="global.html#CategorySchema">CategorySchema</a></li><li><a href="global.html#CategoryValidationSchema">CategoryValidationSchema</a></li><li><a href="global.html#FieldDefinitionSchema">FieldDefinitionSchema</a></li><li><a href="global.html#IPRateLimiter">IPRateLimiter</a></li><li><a href="global.html#OrderItem">OrderItem</a></li><li><a href="global.html#OrderItemModel">OrderItemModel</a></li><li><a href="global.html#OrderModel">OrderModel</a></li><li><a href="global.html#OrderSchema">OrderSchema</a></li><li><a href="global.html#PaginationValidation">PaginationValidation</a></li><li><a href="global.html#ProductFieldValueSchema">ProductFieldValueSchema</a></li><li><a href="global.html#ProductListValidationSchema">ProductListValidationSchema</a></li><li><a href="global.html#ProductModel">ProductModel</a></li><li><a href="global.html#ProductSchema">ProductSchema</a></li><li><a href="global.html#StorageItemModel">StorageItemModel</a></li><li><a href="global.html#UserSchema">UserSchema</a></li><li><a href="global.html#addToCart">addToCart</a></li><li><a href="global.html#adminMiddleware">adminMiddleware</a></li><li><a href="global.html#adminSignIn">adminSignIn</a></li><li><a href="global.html#cancelOrder">cancelOrder</a></li><li><a href="global.html#completeOrder">completeOrder</a></li><li><a href="global.html#createCategory">createCategory</a></li><li><a href="global.html#createCategoryService">createCategoryService</a></li><li><a href="global.html#createNonRegisteredUser">createNonRegisteredUser</a></li><li><a href="global.html#createOrder">createOrder</a></li><li><a href="global.html#createProduct">createProduct</a></li><li><a href="global.html#createProductService">createProductService</a></li><li><a href="global.html#deleteCartItem">deleteCartItem</a></li><li><a href="global.html#deleteCategory">deleteCategory</a></li><li><a href="global.html#deleteCategoryService">deleteCategoryService</a></li><li><a href="global.html#deleteProduct">deleteProduct</a></li><li><a href="global.html#deleteProductService">deleteProductService</a></li><li><a href="global.html#deleteUser">deleteUser</a></li><li><a href="global.html#formatFieldValues">formatFieldValues</a></li><li><a href="global.html#generateOTP">generateOTP</a></li><li><a href="global.html#getAllCategories">getAllCategories</a></li><li><a href="global.html#getAllCategoriesService">getAllCategoriesService</a></li><li><a href="global.html#getAllOrders">getAllOrders</a></li><li><a href="global.html#getAllProducts">getAllProducts</a></li><li><a href="global.html#getAllProductsService">getAllProductsService</a></li><li><a href="global.html#getAllUserCart">getAllUserCart</a></li><li><a href="global.html#getAllUsers">getAllUsers</a></li><li><a href="global.html#getCategoryById">getCategoryById</a></li><li><a href="global.html#getCategoryByIdService">getCategoryByIdService</a></li><li><a href="global.html#getOrderById">getOrderById</a></li><li><a href="global.html#getProductById">getProductById</a></li><li><a href="global.html#getProductByIdService">getProductByIdService</a></li><li><a href="global.html#getUserById">getUserById</a></li><li><a href="global.html#handleLogout">handleLogout</a></li><li><a href="global.html#handleRefreshToken">handleRefreshToken</a></li><li><a href="global.html#isValidMongoId">isValidMongoId</a></li><li><a href="global.html#isValidObjectIdWithOptions">isValidObjectIdWithOptions</a></li><li><a href="global.html#isValidSchemaObjectId">isValidSchemaObjectId</a></li><li><a href="global.html#registerUser">registerUser</a></li><li><a href="global.html#router">router</a></li><li><a href="global.html#saveOTP">saveOTP</a></li><li><a href="global.html#sendOTPByEmail">sendOTPByEmail</a></li><li><a href="global.html#signIn">signIn</a></li><li><a href="global.html#swaggerDocs">swaggerDocs</a></li><li><a href="global.html#updateCartItemQuantity">updateCartItemQuantity</a></li><li><a href="global.html#updateCategory">updateCategory</a></li><li><a href="global.html#updateCategoryService">updateCategoryService</a></li><li><a href="global.html#updateOrder">updateOrder</a></li><li><a href="global.html#updateProduct">updateProduct</a></li><li><a href="global.html#updateProductService">updateProductService</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#uploadRateLimiter">uploadRateLimiter</a></li><li><a href="global.html#userMiddleware">userMiddleware</a></li><li><a href="global.html#validateFieldType">validateFieldType</a></li><li><a href="global.html#verifyOTP">verifyOTP</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Mar 27 2025 08:36:07 GMT+0700 (Indochina Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
