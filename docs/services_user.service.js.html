<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/user.service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/user.service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { User } from "../schemas/user.schema.js";
import { UserValidationSchema } from "../validators/user.validator.js";
import mongoose from "mongoose";

/**
 * @name getAllUsers
 * @description Lấy danh sách tất cả người dùng với phân trang
 * @param {number} start - Vị trí bắt đầu
 * @param {number} limit - Số lượng người dùng trên mỗi trang
 * @returns {Promise&lt;Object>} Danh sách người dùng và thông tin phân trang
 */
const getAllUsers = async (start = 0, limit = 10) => {
  // Convert parameters to integers
  const startIndex = parseInt(start);
  const limitCount = parseInt(limit);
  
  // Get total count first for pagination info
  const total = await User.countDocuments();
  const pages = Math.ceil(total / limitCount);
  
  // Always return pagination info, even with empty results
  if (total === 0) {
    return {
      pages: 0,
      limit: limitCount,
      total: 0,
      users: []
    };
  }
  
  // Fetch users with pagination
  const userList = await User.find({})
    .skip(startIndex)
    .limit(limitCount)
    .select('-password -refreshToken -__v');

  // Transform users through validation schema
  const returnUserList = userList.map(user => {
    return UserValidationSchema.parse({
      id: user._id.toString(),
      name: user.name,
      email: user.email,
      phoneNumber: user.phoneNumber,
      address: user.address,
    });
  });

  // Return consistent response format
  return {
    pages,
    limit: limitCount,
    total,
    users: returnUserList
  };
}

/**
 * @name getUserById
 * @description Lấy thông tin chi tiết của người dùng theo ID
 * @param {string} id - ID của người dùng
 * @param {Object} currentUser - Người dùng hiện tại
 * @returns {Promise&lt;Object>} Thông tin chi tiết của người dùng
 * @throws {Error} Nếu ID không hợp lệ hoặc không tìm thấy người dùng
 */
const getUserById = async (id, currentUser) => {
  if (!mongoose.Types.ObjectId.isValid(id)) {
    throw new Error("Invalid user ID format");
  }

  if (currentUser.role !== 'admin' &amp;&amp; currentUser.id !== id) {
    throw new Error("Access denied. You can only view your own profile.");
  }

  const user = await User.findById(id).select('-password -refreshToken -__v');
  if (!user) {
    throw new Error("User not found");
  }

  return UserValidationSchema.parse({
    id: user._id.toString(),
    name: user.name,
    email: user.email,
    phoneNumber: user.phoneNumber,
    address: user.address,
  });
}

/**
 * @name createNonRegisteredUser
 * @description Tạo một người dùng chưa đăng ký
 * @param {Object} userData - Dữ liệu người dùng
 * @returns {Promise&lt;Object>} Người dùng vừa được tạo
 */
const createNonRegisteredUser = async (userData) => {
  const { name, email, phoneNumber, address } = userData;

    let validatedData;
    try {
      validatedData = UserValidationSchema.parse({ name, email, phoneNumber, address });
    } catch (validationError) {
      throw new Error("Validation error");
    }

    const existingUser = await User.findOne({
      $or: [
        { email: validatedData.email },
        { phoneNumber: validatedData.phoneNumber }
      ]
    });

    if (existingUser) {
      throw new Error("User already exists");
    }

    const newUser = new User({
      ...validatedData,
      isRegistered: false,
      role: "anon",
      password: "",
      refreshToken: ""
    });

    await newUser.save();

    const userResponse = newUser.toObject();
    delete userResponse.password;
    delete userResponse.refreshToken;

    return {
      message: "User created successfully",
      user: userResponse,
    };
}

/**
 * @name updateUser
 * @description Cập nhật thông tin người dùng
 * @param {string} id - ID của người dùng
 * @param {Object} currentUser - Người dùng hiện tại
 * @param {Object} updateData - Dữ liệu cần cập nhật
 * @returns {Promise&lt;Object>} Người dùng sau khi được cập nhật
 * @throws {Error} Nếu ID không hợp lệ hoặc không tìm thấy người dùng
 */
const updateUser = async (id, currentUser, updateData) => {
  if (!mongoose.Types.ObjectId.isValid(id)) {
    throw new Error("Invalid user ID format");
  }

  if (currentUser.role !== 'admin' &amp;&amp; currentUser.id !== id) {
    throw new Error("Access denied. You can only update your own profile.");
  }

  const updateFields = {};
  if (updateData.name !== undefined) updateFields.name = updateData.name.trim();
  if (updateData.email !== undefined) updateFields.email = updateData.email.trim().toLowerCase();
  if (updateData.phoneNumber !== undefined) updateFields.phoneNumber = updateData.phoneNumber.trim();
  if (updateData.address !== undefined) updateFields.address = updateData.address;

  try {
    const updatedUser = await User.findOneAndUpdate(
      { _id: id },
      UserValidationSchema.parse(updateFields),
      { new: true, runValidators: true }
    ).select('-password -refreshToken -__v');

    if (!updatedUser) {
      throw new Error("User not found");
    }

    return updatedUser;
  } catch (validationError) {
    throw new Error("Validation error");
  }
}

/**
 * @name deleteUser
 * @description Xóa người dùng theo ID
 * @param {string} id - ID của người dùng
 * @param {Object} currentUser - Người dùng hiện tại
 * @returns {Promise&lt;void>} Không trả về giá trị
 * @throws {Error} Nếu ID không hợp lệ hoặc không tìm thấy người dùng
 */
const deleteUser = async (id, currentUser) => {
  if (!mongoose.Types.ObjectId.isValid(id)) {
    throw new Error("Invalid user ID format");
  }

  if (currentUser.role !== 'admin' &amp;&amp; currentUser.id !== id) {
    throw new Error("Access denied. You can only delete your own account.");
  }

  const deletedUser = await User.findOneAndDelete({ _id: id });
  if (!deletedUser) {
    throw new Error("User not found");
  }
}

export const UserService = {
  getAllUsers,
  getUserById,
  createNonRegisteredUser,
  updateUser,
  deleteUser,
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#CategoriesValidationSchema">CategoriesValidationSchema</a></li><li><a href="global.html#CategoryModel">CategoryModel</a></li><li><a href="global.html#CategorySchema">CategorySchema</a></li><li><a href="global.html#CategoryValidationSchema">CategoryValidationSchema</a></li><li><a href="global.html#FieldDefinitionSchema">FieldDefinitionSchema</a></li><li><a href="global.html#IPRateLimiter">IPRateLimiter</a></li><li><a href="global.html#OrderItem">OrderItem</a></li><li><a href="global.html#OrderItemModel">OrderItemModel</a></li><li><a href="global.html#OrderModel">OrderModel</a></li><li><a href="global.html#OrderSchema">OrderSchema</a></li><li><a href="global.html#PaginationValidation">PaginationValidation</a></li><li><a href="global.html#ProductFieldValueSchema">ProductFieldValueSchema</a></li><li><a href="global.html#ProductListValidationSchema">ProductListValidationSchema</a></li><li><a href="global.html#ProductModel">ProductModel</a></li><li><a href="global.html#ProductSchema">ProductSchema</a></li><li><a href="global.html#StorageItemModel">StorageItemModel</a></li><li><a href="global.html#UserSchema">UserSchema</a></li><li><a href="global.html#addToCart">addToCart</a></li><li><a href="global.html#adminMiddleware">adminMiddleware</a></li><li><a href="global.html#adminSignIn">adminSignIn</a></li><li><a href="global.html#cancelOrder">cancelOrder</a></li><li><a href="global.html#completeOrder">completeOrder</a></li><li><a href="global.html#createCategory">createCategory</a></li><li><a href="global.html#createCategoryService">createCategoryService</a></li><li><a href="global.html#createNonRegisteredUser">createNonRegisteredUser</a></li><li><a href="global.html#createOrder">createOrder</a></li><li><a href="global.html#createProduct">createProduct</a></li><li><a href="global.html#createProductService">createProductService</a></li><li><a href="global.html#deleteCartItem">deleteCartItem</a></li><li><a href="global.html#deleteCategory">deleteCategory</a></li><li><a href="global.html#deleteCategoryService">deleteCategoryService</a></li><li><a href="global.html#deleteProduct">deleteProduct</a></li><li><a href="global.html#deleteProductService">deleteProductService</a></li><li><a href="global.html#deleteUser">deleteUser</a></li><li><a href="global.html#formatFieldValues">formatFieldValues</a></li><li><a href="global.html#generateOTP">generateOTP</a></li><li><a href="global.html#getAllCategories">getAllCategories</a></li><li><a href="global.html#getAllCategoriesService">getAllCategoriesService</a></li><li><a href="global.html#getAllOrders">getAllOrders</a></li><li><a href="global.html#getAllProducts">getAllProducts</a></li><li><a href="global.html#getAllProductsService">getAllProductsService</a></li><li><a href="global.html#getAllUserCart">getAllUserCart</a></li><li><a href="global.html#getAllUsers">getAllUsers</a></li><li><a href="global.html#getCategoryById">getCategoryById</a></li><li><a href="global.html#getCategoryByIdService">getCategoryByIdService</a></li><li><a href="global.html#getOrderById">getOrderById</a></li><li><a href="global.html#getProductById">getProductById</a></li><li><a href="global.html#getProductByIdService">getProductByIdService</a></li><li><a href="global.html#getUserById">getUserById</a></li><li><a href="global.html#handleLogout">handleLogout</a></li><li><a href="global.html#handleRefreshToken">handleRefreshToken</a></li><li><a href="global.html#isValidMongoId">isValidMongoId</a></li><li><a href="global.html#isValidObjectIdWithOptions">isValidObjectIdWithOptions</a></li><li><a href="global.html#isValidSchemaObjectId">isValidSchemaObjectId</a></li><li><a href="global.html#registerUser">registerUser</a></li><li><a href="global.html#router">router</a></li><li><a href="global.html#saveOTP">saveOTP</a></li><li><a href="global.html#sendOTPByEmail">sendOTPByEmail</a></li><li><a href="global.html#signIn">signIn</a></li><li><a href="global.html#swaggerDocs">swaggerDocs</a></li><li><a href="global.html#updateCartItemQuantity">updateCartItemQuantity</a></li><li><a href="global.html#updateCategory">updateCategory</a></li><li><a href="global.html#updateCategoryService">updateCategoryService</a></li><li><a href="global.html#updateOrder">updateOrder</a></li><li><a href="global.html#updateProduct">updateProduct</a></li><li><a href="global.html#updateProductService">updateProductService</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#uploadRateLimiter">uploadRateLimiter</a></li><li><a href="global.html#userMiddleware">userMiddleware</a></li><li><a href="global.html#validateFieldType">validateFieldType</a></li><li><a href="global.html#verifyOTP">verifyOTP</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Mar 27 2025 08:36:07 GMT+0700 (Indochina Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
